<p-toolbar styleClass="py-2 mb-1">
  <ng-template pTemplate="left">
    <button
      pButton
      pRipple
      type="button"
      icon="fa fa-plus"
      label="Thêm loại"
      class="p-button-sm mr-1 my-1"
      (click)="showAddDialog()"
    ></button>
    <!-- <p-dropdown [options]="visibleOptions" >
      </p-dropdown> -->
  </ng-template>
  <ng-template pTemplate="right">
    <form
      (submit)="dt.filterGlobal(search.value, 'contains')"
      class="p-inputgroup my-1"
    >
      <span class="p-inputgroup-addon"> <i class="pi pi-search"></i></span>
      <input
        pInputText
        type="text"
        #search
        placeholder="Từ khóa tìm kiếm..."
        class="w-100"
      />
      <button pButton type="submit" label="Tìm"></button>
    </form>
  </ng-template>
</p-toolbar>
<p-table
  #dt
  [value]="products"
  [lazy]="true"
  (onLazyLoad)="loadProducts($event)"
  responsiveLayout="stack"
  dataKey="id"
  [selection]="selectedProducts"
  [selectAll]="selectAll"
  [paginator]="true"
  [rows]="10"
  [rowsPerPageOptions]="[5, 10, 15, 25]"
  [totalRecords]="totalRecords"
  [loading]="loading"
  [globalFilterFields]="['name']"
  breakpoint="992px"
>
  <ng-template pTemplate="header">
    <tr>
      <th class="d-lg-table-cell d-none"></th>
      <th>STT</th>
      <th pSortableColumn="name">
        Tên sản phẩm <p-sortIcon field="name"></p-sortIcon>
      </th>
      <th pSortableColumn="quantity">
        Số lượng <p-sortIcon field="quantity"></p-sortIcon>
      </th>
      <th pSortableColumn="created_at">
        Thời gian tạo<p-sortIcon field="created_at"></p-sortIcon>
      </th>
      <th style="width: 7rem"></th>
    </tr>
  </ng-template>
  <ng-template
    pTemplate="body"
    let-product
    let-index="rowIndex"
    let-expanded="expanded"
  >
    <tr>
      <td class="d-lg-table-cell d-none">
        <button
          type="button"
          pButton
          pRipple
          [pRowToggler]="product"
          class="p-button-text p-button-rounded p-button-plain"
          [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
        ></button>
      </td>
      <td><span class="p-column-title">STT</span>{{ index + 1 }}</td>
      <td>
        <span class="p-column-title">Tên sản phẩm</span>{{ product.name }}
      </td>
      <td>
        <span class="p-column-title">Số lượng</span
        >{{ product.quantity | number }}
      </td>
      <td>
        <span class="p-column-title">Thời gian tạo</span
        >{{ product.created_at | date: "dd/MM/yyyy" }}
      </td>
      <td class="d-md-flex">
        <button
          type="button"
          pButton
          pRipple
          [pRowToggler]="product"
          class="p-button-text p-button-rounded p-button-plain d-lg-none"
          [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
        ></button>
        <button
          pButton
          pRipple
          type="button"
          icon="far fa-edit"
          class="p-button-rounded p-button-sm mr-1"
          (click)="showEditDialog(product)"
        ></button>
        <button
          pButton
          pRipple
          type="button"
          icon="far fa-trash-alt"
          class="p-button-rounded p-button-danger"
          (click)="delete(product)"
        ></button>
      </td>
    </tr>
  </ng-template>
  <ng-template pTemplate="rowexpansion" let-product>
    <tr>
      <td colspan="10">
        <div class="p-fluid">
          <div class="row">
            <div class="my-1 p-field col-md-7 col-12">
              <strong>Code</strong>
              <input
                type="text"
                readonly
                [ngModel]="product.code"
                name="product-code"
                id="code"
                pInputText
              />
            </div>
            <div class="my-1 p-field col-md-3 col-sm-6 col-8">
              <strong>Số lựa chọn</strong>
              <input
                type="text"
                readonly
                [ngModel]="product.option_count"
                id="code"
                pInputText
              />
            </div>
            <div class="my-1 p-field col-md-2 col-sm-6 col-4">
              <label class="mr-3">
                <strong>Hiển thị</strong>
              </label>
              <div style="height: 50px" class="d-flex align-items-center">
                <p-inputSwitch
                  [readonly]="true"
                  id="visible"
                  [(ngModel)]="product.visible"
                ></p-inputSwitch>
              </div>
            </div>
            <div class="my-1 p-field col-md-6 col-12">
              <strong>Loại sản phẩm</strong>
              <input pInputText readonly [ngModel]="product?.category?.name" />
            </div>
            <div class="my-1 p-field col-md-6 col-12">
              <strong>Nhà cung cấp</strong>
              <input pInputText readonly [ngModel]="product?.provider?.name" />
            </div>
          </div>
          <div class="my-1 p-field">
            <strong>Mô tả</strong>
            <div
              class="ql-editor"
              [innerHTML]="getSafeHTML(product.description)"
            ></div>
          </div>
          <div class="p-field my-1">
            <div class="d-flex justify-content-between">
              <strong>Ảnh sản phẩm</strong>
              <label for="file" pButton pRipple label="Thêm" icon="pi pi-plus"
              class="p-button-sm w-auto"></label></div>
              <input type="file" accept="image/*" id="file" class="d-none"
              multiple
              (input)="fileInput($event.currentTarget)">
            <div class="d-flex" style="overflow-x: auto">
              <div *ngFor="let image of product.images" class="mx-1 image-block border rounded">
                <!-- <button (click)="deleteFile(image)" class="text-danger"><i class="far fa-times-circle"></i></button> -->
                <img height="100px" [src]="getFilePath(image.blob.file_path)" />
              </div>
            </div>
          </div>
        </div>
      </td>
    </tr>
  </ng-template>
</p-table>

<p-dialog
  [draggable]="true"
  [resizable]="true"
  [maximizable]="true"
  appendTo="body"
  [header]="(displayAddDialog ? 'Thêm' : 'Sửa') + ' sản phẩm'"
  [(visible)]="formVisible"
  styleClass="p-fluid"
  [modal]="true"
  [breakpoints]="{ '960px': '75vw', '640px': '100vw' }"
  [style]="{ width: '50vw' }"
>
  <div class="p-field">
    <label for="name"><strong>Tên sản phẩm</strong></label>
    <input
      type="text"
      [(ngModel)]="product.name"
      name="product-name"
      id="name"
      pInputText
    />
  </div>
  <div class="row">
    <div class="p-field col-md-8 col-12">
      <label for="code"><strong>Code</strong></label>
      <input
        type="text"
        [(ngModel)]="product.code"
        name="product-code"
        id="code"
        pInputText
      />
    </div>
    <div class="p-field col-md-4 col-12">
      <label class="mr-3">
        <strong>Hiển thị</strong>
      </label>
      <div style="height: 50px" class="d-flex align-items-center">
        <p-inputSwitch
          id="visible"
          [(ngModel)]="product.visible"
        ></p-inputSwitch>
      </div>
    </div>
  </div>
  <div class="p-field">
    <label><strong>Loại sản phẩm</strong></label>
    <p-dropdown
      [options]="categories"
      optionValue="id"
      optionLabel="name"
      [virtualScroll]="true"
      [filter]="true"
      filterBy="name"
      [(ngModel)]="product.category_id"
      [showClear]="true"
      emptyMessage="Không có loại sản phẩm"
      emptyFilterMessage="Không có loại sản phẩm"
      appendTo="body"
    >
    </p-dropdown>
  </div>
  <div class="p-field">
    <label><strong>Nhà cung cấp</strong></label>
    <p-dropdown
      [options]="providers"
      optionValue="id"
      optionLabel="name"
      [virtualScroll]="true"
      [filter]="true"
      filterBy="name"
      [(ngModel)]="product.provider_id"
      [showClear]="true"
      emptyMessage="Không có nhà cung cấp"
      emptyFilterMessage="Không có nhà cung cấp"
      appendTo="body"
    >
    </p-dropdown>
  </div>
  <div class="p-field">
    <label><strong>Nhà cung cấp</strong></label>
    <p-editor
      #editor
      [style]="{ height: '320px' }"
      [(ngModel)]="product.description"
    >
    </p-editor>
  </div>
  <div class="p-field my-1">
    <div class="d-flex justify-content-between">
      <strong>Ảnh sản phẩm</strong>
      <label for="file" pButton pRipple label="Thêm" icon="pi pi-plus"
      class="p-button-sm w-auto"></label></div>
      <input type="file" accept="image/*" id="file" class="d-none"
      multiple
      (input)="fileInput($event.currentTarget)">
    <div class="d-flex" style="overflow-x: auto">
      <div *ngFor="let image of newImages" class="mx-1 image-block border rounded">
        <button (click)="deleteFile(image)" class="text-danger"><i class="far fa-times-circle"></i></button>
        <img height="100px" [src]="image.URL" />
      </div>
    </div>
  </div>
  <ng-template pTemplate="footer">
    <button
      *ngIf="displayAddDialog"
      pButton
      pRipple
      icon="fas fa-check"
      class="p-button-success p-button-sm"
      label="Thêm"
      type="button"
      (click)="add()"
    ></button>
    <button
      *ngIf="displayEditDialog"
      pButton
      pRipple
      icon="fas fa-check"
      class="p-button-success p-button-sm"
      label="Lưu"
      type="button"
      (click)="save()"
    ></button>
    <button
      pButton
      pRipple
      class="p-button-danger p-button-sm"
      label="Hủy"
      type="button"
      (click)="formVisible = false; nameInvalid = false"
    ></button>
  </ng-template>
</p-dialog>
